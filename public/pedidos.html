<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Pedidos - SlotEats</title>
    <style>
        :root { --primary: #e84118; --dark: #2f3542; --success: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .pedido-card { 
            background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative;
        }
        .status-badge { 
            position: absolute; top: 20px; right: 20px; 
            padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;
            background: var(--light); color: var(--dark); border: 1px solid #ddd;
        }
        .status-En.Camino { background: #fff3cd; color: #856404; border-color: #ffeeba; }
        .status-Recibido { background: #d1ecf1; color: #0c5460; border-color: #bee5eb; }

        .items-list { color: #666; font-size: 14px; margin: 10px 0; padding-left: 20px; }
        .total-price { font-size: 20px; font-weight: 900; color: var(--primary); }
        .btn-cancel { 
            background: #fff0f0; color: #ff4757; border: none; padding: 8px 15px; 
            border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: bold; margin-top: 10px;
        }
        .info-entrega { font-size: 12px; color: #888; margin-top: 10px; border-top: 1px dashed #eee; padding-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 style="margin:0;">Mis Pedidos üçï</h1>
        <a href="home.html" style="text-decoration:none; color:var(--primary); font-weight:bold;">Volver</a>
    </header>

    <div id="listaPedidos">
        <p style="text-align:center; color:#999;">Consultando a la cocina...</p>
    </div>
</div>

<script>
    async function cargarMisPedidos() {
        const usuario = JSON.parse(localStorage.getItem('usuario'));
        if (!usuario) {
            document.getElementById('listaPedidos').innerHTML = "<p>Inicia sesi√≥n para ver tus pedidos.</p>";
            return;
        }

        try {
            // Llamamos a la ruta de tu server.js
            const res = await fetch(`/mis-pedidos/${usuario.email}`);
            const pedidos = await res.json();

            if (pedidos.length === 0) {
                document.getElementById('listaPedidos').innerHTML = "<p style='text-align:center;'>A√∫n no has hecho pedidos. ¬°El hambre no espera! üçî</p>";
                return;
            }

            document.getElementById('listaPedidos').innerHTML = pedidos.map(p => `
                <div class="pedido-card">
                    <div class="status-badge status-${p.estatus.replace(" ", ".")}">${p.estatus}</div>
                    <div style="font-size: 12px; color: #999;">Pedido #${p._id.substring(18)}</div>
                    <div style="font-weight: bold; margin: 5px 0;">${new Date(p.fecha).toLocaleString()}</div>
                    
                    <ul class="items-list">
                        ${p.items.map(item => `<li>${item.nombre} - $${item.precio}</li>`).join('')}
                    </ul>

                    <div class="total-price">$${p.total.toFixed(2)}</div>

                    <div class="info-entrega">
                        üìç <b>Entrega en:</b> ${p.ubicacion}<br>
                        üìè <b>Distancia:</b> ${p.distanciaKm} km
                    </div>

                    ${p.estatus === 'Recibido' ? 
                        `<button class="btn-cancel" onclick="cancelarPedido('${p._id}')">Cancelar Pedido</button>` 
                        : ''}
                </div>
            `).join('');

        } catch (e) {
            console.error(e);
            document.getElementById('listaPedidos').innerHTML = "<p>Error al conectar con el servidor.</p>";
        }
    }

    async function cancelarPedido(id) {
        if(!confirm("¬øSeguro que quieres cancelar tu comida? üò¢")) return;

        try {
            const res = await fetch(`/cancelar-pedido/${id}`, { method: 'DELETE' });
            const data = await res.json();

            if(res.ok) {
                alert("‚úÖ " + data.msg);
                cargarMisPedidos(); // Recargar lista
            } else {
                alert("‚ùå " + data.msg);
            }
        } catch (e) {
            alert("No se pudo cancelar.");
        }
    }

    // Cargar al iniciar
    window.onload = cargarMisPedidos;
</script>
</body>
</html>