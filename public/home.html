<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SlotEats - Home</title>
    <style>
        :root { 
            --primary: #e84118; 
            --secondary: #ff4757; 
            --dark: #2f3542; 
            --light: #fef2f2; 
            --success: #27ae60; 
            --warning: #f1c40f;
            --gold: #fbc531; 
            --ice: #74b9ff;
        }
        
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #fafafa; color: var(--dark); overflow-x: hidden; }
        
        header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { font-size: 26px; font-weight: 900; cursor: pointer; }
        .logo span:first-child { color: var(--primary); }
        .logo span:last-child { color: var(--dark); }
        
        .user-controls { display: flex; align-items: center; gap: 12px; }
        
        .btn-nav { padding: 8px 15px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 13px; text-decoration: none; transition: 0.3s; border: none; display: flex; align-items: center; gap: 5px; position: relative; overflow: hidden; }
        
        .btn-ranking { background: var(--gold); color: var(--dark); }
        .btn-ranking::after {
            content: ''; position: absolute; top: -50%; left: -60%; width: 20%; height: 200%;
            background: rgba(255, 255, 255, 0.4); transform: rotate(30deg); animation: shine 3s infinite;
        }
        @keyframes shine { 0% { left: -60%; } 20% { left: 120%; } 100% { left: 120%; } }

        .btn-my-reservations { background: var(--light); color: var(--primary); border: 2px solid var(--primary); }
        .btn-my-orders { background: var(--primary); color: white; } 
        .btn-logout { background: #f1f2f6; color: var(--secondary); }

        /* Panel Admin Bot√≥n r√°pido */
        .btn-admin-view { background: var(--dark); color: white; display: none; }

        #rankingPanel {
            position: fixed; top: 0; right: -400px; width: 350px; height: 100%;
            background: white; z-index: 2000; box-shadow: -5px 0 25px rgba(0,0,0,0.15);
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); padding: 25px;
            overflow-y: auto;
        }
        #rankingPanel.active { right: 0; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999; backdrop-filter: blur(3px); }
        
        .rank-section { margin-bottom: 30px; }
        .rank-section h3 { font-size: 18px; border-bottom: 2px solid var(--light); padding-bottom: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        
        .rank-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; font-size: 14px; font-weight: 600; }
        .rank-bar-bg { background: #eee; height: 8px; border-radius: 4px; width: 100%; margin-top: 5px; overflow: hidden; }
        .rank-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 4px; width: 0%; transition: width 1s ease-out; }
        
        .low-demand-bar { background: linear-gradient(90deg, var(--ice), #a29bfe) !important; }

        .categories-container { background: white; padding: 20px 0; border-bottom: 1px solid #eee; }
        .categories-list { display: flex; overflow-x: auto; padding: 0 25px; gap: 20px; scrollbar-width: none; }
        .cat-item { min-width: 75px; text-align: center; cursor: pointer; transition: 0.3s; }
        .cat-item:hover { transform: translateY(-5px); }
        .cat-icon { width: 60px; height: 60px; background: var(--light); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 30px; margin-bottom: 8px; }

        .main-content { padding: 25px; max-width: 1200px; margin: 0 auto; }
        .restaurant-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        
        .res-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); position: relative; transition: 0.3s; }
        .res-image { width: 100%; height: 180px; background-size: cover; background-position: center; }
        .status-badge { position: absolute; top: 15px; right: 15px; padding: 6px 12px; border-radius: 10px; font-size: 11px; font-weight: bold; color: white; text-transform: capitalize; }
        .badge-disponible { background: var(--success); }
        .badge-saturado { background: var(--warning); color: var(--dark); }
        .badge-cerrado { background: #95a5a6; }

        .res-info { padding: 20px; }
        .res-actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .btn-order { background: var(--primary); color: white; }
        .btn-reserve { background: white; color: var(--primary); border: 2px solid var(--primary); }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
    </style>
</head>
<body>

<header>
    <div style="display: flex; align-items: center;">
        <span class="home-icon" id="homeBtn" onclick="showAll()" style="display:none; cursor:pointer; margin-right:10px; font-size: 20px;">üè†</span>
        <div class="logo" onclick="showAll()"><span>Slot</span><span>Eats</span></div>
    </div>
    <div class="user-controls">
        <div id="welcomeMsg" style="font-weight: 600; color: var(--primary); margin-right: 10px;">Hola, Gourmet</div>
        
        <a href="admin.html" id="btnAdminPanel" class="btn-nav btn-admin-view">üõ†Ô∏è Panel Admin</a>
        
        <button class="btn-nav btn-ranking" onclick="toggleRanking()">‚≠ê Ranking</button>
        <a href="pedidos.html" class="btn-nav btn-my-orders">ü•° Mis Pedidos</a>
        <a href="mis-reservas.html" class="btn-nav btn-my-reservations">üìÖ Reservas</a>
        <button class="btn-nav btn-logout" onclick="cerrarSesion()">Salir üö™</button>
    </div>
</header>

<div class="overlay" id="rankingOverlay" onclick="toggleRanking()"></div>
<div id="rankingPanel">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin:0; color:var(--primary);">SlotStats üìä</h2>
        <button onclick="toggleRanking()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
    </div>

    <div id="rankingLoader" style="text-align:center; padding:20px; display:none;">Cargando datos reales...</div>

    <div id="statsContent">
        <div class="rank-section">
            <h3>üèÜ Top 5 Restaurantes</h3>
            <div id="topRes"></div>
        </div>

        <div class="rank-section">
            <h3>üî• Top Comidas</h3>
            <div id="topFood"></div>
        </div>

        <div class="rank-section">
            <h3 style="color: var(--ice);">‚ùÑÔ∏è Menos Solicitados</h3>
            <div id="lowRes"></div>
        </div>
    </div>
</div>

<div class="categories-container">
    <div class="categories-list">
        <div class="cat-item" onclick="filterBy('Hamburguesas')"><div class="cat-icon">üçî</div><p>Burgers</p></div>
        <div class="cat-item" onclick="filterBy('Pizza')"><div class="cat-icon">üçï</div><p>Pizza</p></div>
        <div class="cat-item" onclick="filterBy('Sushi')"><div class="cat-icon">üç£</div><p>Sushi</p></div>
        <div class="cat-item" onclick="filterBy('Pollo')"><div class="cat-icon">üçó</div><p>Pollo</p></div>
    </div>
</div>

<div class="main-content">
    <h3 id="currentCategory">Restaurantes Disponibles</h3>
    <div class="restaurant-grid" id="resGrid"></div>
</div>

<script>
    // --- SEGURIDAD ---
    if (localStorage.getItem('sesionActiva') !== 'true') {
        window.location.href = 'index.html';
    }

    function cerrarSesion() { 
        localStorage.clear(); 
        window.location.href = 'index.html'; 
    }

    const restaurantes = [
        { nombre: "Burger Galaxy", cat: "Hamburguesas", img: "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=500", status: "disponible", horario: "12:00 PM - 11:00 PM" },
        { nombre: "Pizza Nostra", cat: "Pizza", img: "https://images.unsplash.com/photo-1513104890138-7c749659a591?w=500", status: "saturado", horario: "02:00 PM - 10:00 PM" },
        { nombre: "Sushi Master", cat: "Sushi", img: "https://images.unsplash.com/photo-1579871494447-9811cf80d66c?w=500", status: "disponible", horario: "01:00 PM - 11:00 PM" },
        { nombre: "Chicken House", cat: "Pollo", img: "https://images.unsplash.com/photo-1626082866744-32fe3e0850ff?w=500", status: "cerrado", horario: "11:00 AM - 09:00 PM" }
    ];

    async function toggleRanking() {
        const panel = document.getElementById('rankingPanel');
        const overlay = document.getElementById('rankingOverlay');
        const loader = document.getElementById('rankingLoader');
        const content = document.getElementById('statsContent');

        panel.classList.toggle('active');
        overlay.style.display = panel.classList.contains('active') ? 'block' : 'none';

        if (panel.classList.contains('active')) {
            loader.style.display = "block";
            content.style.opacity = "0.3";
            
            try {
                const response = await fetch('/stats-ranking');
                const data = await response.json();

                document.getElementById('topRes').innerHTML = data.topRestaurantes.map(r => `
                    <div style="margin-bottom:15px;">
                        <div class="rank-item"><span>${r.nombre}</span> <span>${r.cantidad} citas</span></div>
                        <div class="rank-bar-bg"><div class="rank-bar-fill" style="width:${r.porcentaje}%"></div></div>
                    </div>`).join('');

                document.getElementById('topFood').innerHTML = data.topComidas.map(f => `
                    <div class="rank-item" style="background:#fff5f5; padding:8px; border-radius:8px; margin-bottom:8px;">
                        <span>üìç ${f.nombre}</span> <b style="color:var(--primary);">${f.pedidos} pts</b>
                    </div>`).join('');

                if(data.menosSolicitados) {
                    document.getElementById('lowRes').innerHTML = data.menosSolicitados.map(r => `
                        <div style="margin-bottom:15px;">
                            <div class="rank-item"><span>${r.nombre}</span> <span style="color:var(--ice);">${r.porcentaje}%</span></div>
                            <div class="rank-bar-bg"><div class="rank-bar-fill low-demand-bar" style="width:${r.porcentaje}%"></div></div>
                        </div>`).join('');
                }

                content.style.opacity = "1";
            } catch (e) {
                console.error("Error cargando stats");
                document.getElementById('statsContent').innerHTML = "<p style='text-align:center; color:red;'>Error al conectar con el servidor.</p>";
            } finally {
                loader.style.display = "none";
            }
        }
    }

    function renderRes(lista) {
        document.getElementById('resGrid').innerHTML = lista.map(res => `
            <div class="res-card">
                <div class="status-badge badge-${res.status}">${res.status}</div>
                <div class="res-image" style="background-image: url('${res.img}')"></div>
                <div class="res-info">
                    <h4 style="margin:0 0 10px 0;">${res.nombre}</h4>
                    <p style="font-size:13px; color:#666; margin:5px 0;">üç¥ ${res.cat}</p>
                    <p style="font-size:13px; color:#666; margin:5px 0;">üïí ${res.horario}</p>
                    <div class="res-actions">
                        <button class="btn btn-order" onclick="window.location.href='menu.html?res=${encodeURIComponent(res.nombre)}'">Ver Men√∫</button>
                        <button class="btn btn-reserve" ${res.status === 'cerrado' ? 'disabled style="opacity:0.4; cursor:not-allowed;"' : ''} 
                            onclick="window.location.href='reserva.html?res=${encodeURIComponent(res.nombre)}'">Reservar</button>
                    </div>
                </div>
            </div>`).join('');
    }

    function filterBy(cat) {
        document.getElementById('homeBtn').style.display = "block";
        document.getElementById('currentCategory').innerText = "Lo mejor en " + cat;
        renderRes(restaurantes.filter(r => r.cat === cat));
    }

    function showAll() {
        document.getElementById('homeBtn').style.display = "none";
        document.getElementById('currentCategory').innerText = "Restaurantes Disponibles";
        renderRes(restaurantes);
    }

    window.onload = () => {
        // --- L√ìGICA DE USUARIO ---
        const nombre = localStorage.getItem('userNombre') || 'Gourmet';
        const tipo = localStorage.getItem('userTipo');
        
        document.getElementById('welcomeMsg').innerText = "Hola, " + nombre;

        // Mostrar bot√≥n de admin solo si es staff
        if (tipo === 'staff') {
            document.getElementById('btnAdminPanel').style.display = 'flex';
        }

        renderRes(restaurantes);
    };
</script>
</body>
</html>