<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SlotEats - Men√∫</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { 
            --primary: #e84118; 
            --dark: #2f3542; 
            --light: #fef2f2; 
            --success: #27ae60;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #fafafa; padding-bottom: 80px; }
        
        header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top:0; z-index:100; }
        .btn-back { cursor: pointer; font-weight: bold; color: var(--primary); text-decoration: none; }

        .menu-container { padding: 20px; max-width: 800px; margin: 0 auto; }
        .food-card { 
            background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; 
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.3s;
        }
        .food-info h3 { margin: 0; font-size: 18px; }
        .food-info p { margin: 5px 0; color: #666; font-size: 14px; }
        .price { color: var(--primary); font-weight: 900; font-size: 18px; }

        .btn-add { 
            background: var(--primary); color: white; border: none; padding: 10px 15px; 
            border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s;
        }

        .cart-float {
            position: fixed; bottom: 25px; right: 25px; 
            background: var(--dark); color: white; width: 65px; height: 65px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 1000; transition: 0.3s;
        }
        .cart-count {
            position: absolute; top: 0; right: 0; background: var(--primary);
            color: white; font-size: 12px; width: 22px; height: 22px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; border: 2px solid white;
        }

        #cartPanel {
            position: fixed; top: 0; right: -400px; width: 350px; height: 100%;
            background: white; z-index: 2001; box-shadow: -5px 0 25px rgba(0,0,0,0.2);
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); padding: 25px; display: flex; flex-direction: column;
        }
        #cartPanel.active { right: 0; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .btn-remove { color: #ff4757; background: none; border: none; cursor: pointer; font-size: 12px; font-weight: bold; }

        .checkout-form input { 
            width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-family: inherit;
        }
        
        .btn-pay { 
            background: var(--success); color: white; border: none; width: 100%; padding: 15px; 
            border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: auto;
        }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }

        #mapOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; backdrop-filter: blur(4px); }
        #mapModal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 450px; background: white; z-index: 3001; border-radius: 20px; padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
        }
        #map { height: 250px; width: 100%; border-radius: 12px; margin: 15px 0; border: 1px solid #eee; }
        .logistica-info { background: #f8f9fa; padding: 12px; border-radius: 10px; font-size: 13px; border: 1px solid #eee; }
    </style>
</head>
<body>

<header>
    <a href="home.html" class="btn-back">‚¨Ö Volver</a>
    <div id="restauranteTitulo" style="font-weight: 900; font-size: 20px;">Men√∫</div>
    <div style="width: 30px;"></div>
</header>

<div class="menu-container" id="menuLista"></div>

<div class="cart-float" onclick="toggleCart()">
    üçî <div class="cart-count" id="cartCount">0</div>
</div>

<div class="overlay" id="cartOverlay" onclick="toggleCart()"></div>

<div id="cartPanel">
    <h2 style="margin-top:0;">Mi Pedido ü•°</h2>
    <div id="cartItems" style="flex-grow: 1; overflow-y: auto;"></div>

    <div class="checkout-form">
        <hr style="border: 0; border-top: 1px solid #eee;">
        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:20px; margin:15px 0;">
            <span>Subtotal:</span> <span id="cartTotal">$0.00</span>
        </div>
        <input type="text" id="nombrePedido" placeholder="¬øA nombre de qui√©n?">
        <button class="btn-pay" onclick="abrirConfirmacionMapa()">Elegir Destino y Pedir üöÄ</button>
    </div>
</div>

<div id="mapOverlay" onclick="cerrarMapa()"></div>
<div id="mapModal">
    <h3 style="margin:0; color:var(--primary);">üìç Punto de Entrega</h3>
    <p style="font-size:12px; color:#666; margin:5px 0;">Mueve el marcador hasta tu ubicaci√≥n exacta.</p>
    
    <div id="map"></div>
    
    <div class="logistica-info">
        <b>üó∫Ô∏è Direcci√≥n:</b> <span id="txtCalle">Buscando...</span><br>
        <b>üìè Distancia:</b> <span id="txtKm">0.0 km</span><br>
        <b>üí∞ Costo Env√≠o:</b> <span id="txtEnvio">$0.00</span>
    </div>

    <button class="btn-pay" style="margin-top:15px;" onclick="enviarPedidoFinal()">Confirmar Pedido Todo Ok</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // BASE DE DATOS DE RESTAURANTES (Coordenadas CDMX)
    const DB_RES = {
        "Burger Galaxy": { lat: 19.4339, lng: -99.1389 },
        "Pizza Nostra": { lat: 19.4194, lng: -99.1673 },
        "Sushi Master": { lat: 19.4312, lng: -99.1841 },
        "Chicken House": { lat: 19.3552, lng: -99.1636 },
        "Taco Planet": { lat: 19.4270, lng: -99.1676 }
    };

    const platillosBase = [
        { id: 1, nombre: "Monster Burger", desc: "Doble carne, tocino y mucho queso.", precio: 150, res: "Burger Galaxy" },
        { id: 2, nombre: "Pizza Peperoni", desc: "Masa artesanal y extra queso.", precio: 180, res: "Pizza Nostra" },
        { id: 3, nombre: "Sushi Master Roll", desc: "Salm√≥n fresco y aguacate.", precio: 220, res: "Sushi Master" },
        { id: 4, nombre: "Alitas BBQ", desc: "12 piezas crujientes.", precio: 130, res: "Chicken House" },
        { id: 5, nombre: "Tacos al Pastor", desc: "Orden de 5 con pi√±a y salsa.", precio: 95, res: "Taco Planet" }
    ];

    let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
    let map, marker;
    let datosLogistica = { km: 0, costo: 0, calle: "" };
    let resActualCoord = { lat: 19.4326, lng: -99.1332 }; 

    function cargarMenu() {
        const urlParams = new URLSearchParams(window.location.search);
        const resNombre = urlParams.get('res');
        
        if(resNombre) {
            document.getElementById('restauranteTitulo').innerText = resNombre;
            if(DB_RES[resNombre]) resActualCoord = DB_RES[resNombre];
        }

        const listaFiltrada = resNombre ? platillosBase.filter(p => p.res === resNombre) : platillosBase;
        
        document.getElementById('menuLista').innerHTML = listaFiltrada.map(p => `
            <div class="food-card">
                <div class="food-info">
                    <h3>${p.nombre}</h3>
                    <p>${p.desc}</p>
                    <span class="price">$${p.precio}</span>
                </div>
                <button class="btn-add" onclick="agregarAlCarrito(${p.id})">Agregar +</button>
            </div>
        `).join('');

        const userNombre = localStorage.getItem('userNombre');
        if(userNombre) document.getElementById('nombrePedido').value = userNombre;
        
        actualizarInterfazCarrito();
    }

    function agregarAlCarrito(id) {
        const producto = platillosBase.find(p => p.id === id);
        carrito.push({...producto});
        localStorage.setItem('carrito', JSON.stringify(carrito));
        actualizarInterfazCarrito();
    }

    function quitarDelCarrito(index) {
        carrito.splice(index, 1);
        localStorage.setItem('carrito', JSON.stringify(carrito));
        actualizarInterfazCarrito();
    }

    function actualizarInterfazCarrito() {
        document.getElementById('cartCount').innerText = carrito.length;
        const lista = document.getElementById('cartItems');
        let total = 0;
        
        if (carrito.length === 0) {
            lista.innerHTML = `<p style="text-align:center; color:#999; margin-top:50px;">Tu bolsita est√° vac√≠a üåÆ</p>`;
        } else {
            lista.innerHTML = carrito.map((p, index) => {
                total += p.precio;
                return `<div class="cart-item">
                    <div><b>${p.nombre}</b><br><small>$${p.precio}</small></div>
                    <button class="btn-remove" onclick="quitarDelCarrito(${index})">‚ùå</button>
                </div>`;
            }).join('');
        }
        document.getElementById('cartTotal').innerText = `$${total.toFixed(2)}`;
    }

    function toggleCart() {
        document.getElementById('cartPanel').classList.toggle('active');
        document.getElementById('cartOverlay').style.display = document.getElementById('cartPanel').classList.contains('active') ? 'block' : 'none';
    }

    function abrirConfirmacionMapa() {
        if(carrito.length === 0 || !document.getElementById('nombrePedido').value) {
            return alert("Completa tu nombre y agrega comida.");
        }
        toggleCart();
        document.getElementById('mapOverlay').style.display = 'block';
        document.getElementById('mapModal').style.display = 'block';

        if (!map) {
            map = L.map('map').setView([resActualCoord.lat, resActualCoord.lng], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            marker = L.marker([resActualCoord.lat, resActualCoord.lng], {draggable: true}).addTo(map);
            marker.on('dragend', (e) => calcularDistanciaReal(e.target.getLatLng()));
        }
        // Calcular log√≠stica inicial al abrir
        calcularDistanciaReal(marker.getLatLng());
    }

    function cerrarMapa() {
        document.getElementById('mapOverlay').style.display = 'none';
        document.getElementById('mapModal').style.display = 'none';
    }

    function calcularDistanciaReal(pos) {
        const R = 6371;
        const dLat = (pos.lat - resActualCoord.lat) * Math.PI / 180;
        const dLon = (pos.lng - resActualCoord.lng) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(resActualCoord.lat * Math.PI / 180) * Math.cos(pos.lat * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const km = R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        
        const costoEnvio = km * 12; 
        datosLogistica = { km: km.toFixed(2), costo: costoEnvio.toFixed(2) };

        document.getElementById('txtKm').innerText = km.toFixed(2) + " km";
        document.getElementById('txtEnvio').innerText = "$" + costoEnvio.toFixed(2);

        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.lat}&lon=${pos.lng}`)
            .then(r => r.json()).then(data => {
                datosLogistica.calle = data.display_name;
                const partes = data.display_name.split(',');
                document.getElementById('txtCalle').innerText = partes[0] + (partes[1] ? ", " + partes[1] : "");
            });
    }

    async function enviarPedidoFinal() {
        const subtotal = carrito.reduce((s, p) => s + p.precio, 0);
        // CORRECCI√ìN INTEGRADA: Extraer email del localStorage para que el server lo reciba bien
        const emailCliente = localStorage.getItem('userEmail') || "invitado@mail.com";
        const restauranteNombre = document.getElementById('restauranteTitulo').innerText;

        const pedidoData = {
            restaurante: restauranteNombre,
            nombreCliente: document.getElementById('nombrePedido').value,
            emailCliente: emailCliente,
            items: carrito,
            total: (parseFloat(subtotal) + parseFloat(datosLogistica.costo)).toFixed(2),
            ubicacion: datosLogistica.calle,
            distanciaKm: parseFloat(datosLogistica.km)
        };

        try {
            const response = await fetch('/enviar-pedido', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pedidoData)
            });

            if (response.ok) {
                alert("üöÄ ¬°Pedido confirmado! Te redirigimos al rastreo.");
                localStorage.removeItem('carrito');
                window.location.href = "mis-pedidos.html"; 
            } else {
                const err = await response.json();
                alert("Error del servidor: " + err.msg);
            }
        } catch (e) {
            alert("Error de conexi√≥n con el servidor.");
        }
    }

    window.onload = cargarMenu;
</script>
</body>
</html>