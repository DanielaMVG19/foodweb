<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservar en SlotEats</title>
    <style>
        :root { --primary: #e84118; --secondary: #ff4757; --dark: #2f3542; --success: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: #fef2f2; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .form-box { background: white; padding: 40px; border-radius: 25px; width: 100%; max-width: 350px; box-shadow: 0 10px 30px rgba(232, 65, 24, 0.1); text-align: center; }
        h3 { color: var(--primary); margin-bottom: 10px; font-size: 24px; }
        .input-group { text-align: left; margin-bottom: 15px; }
        label { font-size: 12px; font-weight: bold; color: var(--dark); margin-left: 5px; }
        input, textarea { width: 100%; margin-top: 5px; padding: 14px; border: 2px solid #eee; border-radius: 12px; box-sizing: border-box; outline: none; font-size: 15px; font-family: inherit; }
        textarea { resize: none; height: 80px; }
        button { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; margin-top: 10px; }
        button:hover { background: var(--secondary); transform: translateY(-2px); }
        .btn-qr { background: var(--success); }
        .back { display: block; margin-top: 20px; color: #999; text-decoration: none; font-size: 14px; }
        #qrDisplay img { margin-top: 15px; border: 8px solid #f9f9f9; border-radius: 10px; width: 180px; }
        .info-timer { font-size: 12px; color: #666; margin-top: 10px; background: #fff5f5; padding: 10px; border-radius: 8px; border: 1px solid #ffebeb; }
    </style>
</head>
<body>
    <div class="form-box" id="contenido">
        <h3 id="resTitle">Reservar</h3>
        <p id="subTitle" style="color:#666; font-size: 14px; margin-bottom: 25px;">Asegura tu lugar en pocos pasos.</p>
        
        <div id="resForm">
            <div class="input-group">
                <label>Nombre de la reserva</label>
                <input type="text" id="nombreCliente" placeholder="¬øA nombre de qui√©n?" required>
            </div>
            <div class="input-group">
                <label>N√∫mero de personas</label>
                <input type="number" id="personas" min="1" max="20" value="2" required>
            </div>
            <div class="input-group">
                <label>Fecha</label>
                <input type="date" id="fechaReserva" required>
            </div>
            <div class="input-group">
                <label>Hora</label>
                <input type="time" id="hora" required>
            </div>
            <div class="input-group">
                <label>Notas adicionales (Opcional)</label>
                <textarea id="notas" placeholder="Ej: mesa en terraza..."></textarea>
            </div>
            <button id="btnConfirmar">Confirmar Reserva</button>
        </div>

        <div id="qrSeccion" style="display:none;">
            <div id="qrDisplay"></div>
            <div id="controlQR">
                <p class="info-timer">‚ÑπÔ∏è Recuerda: Solo puedes generar un c√≥digo QR cada 24 horas por reserva.</p>
                <button id="btnGenerarQR" class="btn-qr">Solicitar C√≥digo QR</button>
            </div>
        </div>

        <a href="home.html" class="back">‚¨Ö Volver al inicio</a>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const restauranteSeleccionado = params.get('res') || "Restaurante";
        document.getElementById('resTitle').innerText = "Reserva en " + restauranteSeleccionado;
        
        let idNuevaReserva = null;

        // 1. CONFIRMAR RESERVA
        document.getElementById('btnConfirmar').addEventListener('click', async () => {
            const data = {
                restaurante: restauranteSeleccionado,
                nombreCliente: document.getElementById('nombreCliente').value,
                personas: document.getElementById('personas').value,
                fecha: document.getElementById('fechaReserva').value,
                hora: document.getElementById('hora').value,
                notas: document.getElementById('notas').value
            };

            if(!data.nombreCliente || !data.fecha || !data.hora) return alert("Completa los campos obligatorios");

            try {
                const response = await fetch('/reserve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (response.ok) {
                    idNuevaReserva = result.id; 
                    alert("üéâ ¬°Reserva guardada!");
                    document.getElementById('resForm').style.display = 'none';
                    document.getElementById('subTitle').innerText = "Estado: Pendiente de validaci√≥n.";
                    document.getElementById('qrSeccion').style.display = 'block';
                }
            } catch (error) { alert("Error al conectar con el servidor"); }
        });

        // 2. SOLICITAR QR (Aqu√≠ el servidor aplicar√° el bloqueo de 24h)
        document.getElementById('btnGenerarQR').addEventListener('click', async () => {
            try {
                const response = await fetch('/generar-qr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reservaId: idNuevaReserva })
                });
                
                const result = await response.json();

                if (response.ok) {
                    // Si el servidor lo permite (pasaron 24h o es el primero)
                    document.getElementById('qrDisplay').innerHTML = `<img src="${result.qrImagen}">`;
                    document.getElementById('controlQR').innerHTML = "<p style='color:var(--success); font-weight:bold;'>‚úÖ Pase generado con √©xito</p>";
                } else {
                    // Si el servidor bloquea (faltan horas para cumplir las 24h)
                    alert(result.msg); 
                }
            } catch (e) { 
                alert("Error al procesar la solicitud del QR"); 
            }
        });
    </script>
</body>
</html>